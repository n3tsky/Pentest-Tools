##################
###### Variables
##################
GREEN="\033[0;32m"
RED="\033[0;31m"
ORANGE="\033[0;33m"
NOCOLOR="\033[0m"

# Options
if [ "$verbose" == "false" ]; then
  QUIET="--quiet"
else
  QUIET=""
fi

# Binaries
APT="/usr/bin/apt"
GIT="/usr/bin/git"
MAKE="/usr/bin/make"
MKDIR="/bin/mkdir"
PIP="/usr/bin/pip"
RM="/bin/rm"
SUDO="/usr/bin/sudo"
TAR="/bin/tar"
WGET="/usr/bin/wget"
7Z="/usr/bin/7z"
##################
###### Functions
##################

# Helper function
function f_help() {
  printf "Usage: "
}

# Generic function to print stuff
function f_print() {
  # Something to print?
  if [ $# != 0 ]; then
    if [ $# == 1 ]; then
      # Just print the message
      echo -e "${NOCOLOR}$1${NOCOLOR}"
    else
      if [ $2 == "error" ]; then
        echo -e "${RED}$1${NOCOLOR}"
      elif [ $2 == "ok" ]; then
        echo -e "${GREEN}$1${NOCOLOR}"
      elif [ $2 == "warning" ]; then
        echo -e "${ORANGE}$1${NOCOLOR}"
      fi
    fi
  fi
}

# Install through git
function f_install_git_clone() {
  LABEL=$1
  URL=$2
  DEST=$3
  OPTS=$4

  f_print "\n\t[*] Installing $LABEL"
  cmd="$GIT clone $QUIET $OPTS $URL $DEST"
  f_print "\t[*] cmd: $cmd"
  $GIT clone $QUIET $OPTS $URL $DEST
  f_print "\t[*] Installed $LABEL - done" "ok"
}

# Install through wget
function f_install_wget() {
  LABEL=$1
  URL=$2
  DEST=$3
  OPTS=$4

  f_print "\n\t[*] Installing $LABEL"
  cmd="$WGET $QUIET $URL $OPTS -O $DEST"
  f_print "\t[*] cmd: $cmd"
  $WGET $QUIET $URL $OPTS -O $DEST
  f_print "\t[*] Installed $LABEL - done" "ok"
}

# Execute commands as a low privileged user
function f_execute_as_low_user() {
  SU_USERNAME=$1
  CMD=$2
  $SU "$SU_USERNAME" -c "$CMD"
}

function f_install_dependencies() {

  # CME: libssl-dev libffi-dev python-dev build-essential
  PKG="libssl-dev libffi-dev python-dev build-essential"
  f_print "\n[*] Installing dependencies"
  # Display list of dependencies
  # Install dependencies
  $SUDO $APT install -qq -y ${PKG[@]}

  f_print "\n[*] Installing dependencies - done" "ok"
}

########################################
# WEB
########################################
function f_install_tools_web() {
  prefix="$directory/Tools/web/"
  f_print "\n[*] Install web tools ($prefix)"

  # reGeorg
  f_install_git_clone "reGeorg" "https://github.com/sensepost/reGeorg.git" "$prefix/reGeorg"
  # Tunna
  f_install_git_clone "Tunna" "https://github.com/SECFORCE/Tunna.git" "$prefix/tunna"
  # SQLMap
  f_install_git_clone "SQLMap" "https://github.com/sqlmapproject/sqlmap.git" "$prefix/sqlmap"
  # WFuzz
  f_install_git_clone "WFuzz" "https://github.com/xmendez/wfuzz.git" "$prefix/wfuzz"
  # Loubia
  f_install_git_clone "Loubia" "https://github.com/metalnas/loubia.git" "$prefix/loubia"

  # Dirbuster
  f_install_wget "Dirbuster" "https://downloads.sourceforge.net/dirbuster/DirBuster-0.12.tar.bz2" "$prefix/dirbuster-0.12.tar.bz2"
  $TAR -xvf "$prefix/dirbuster-0.12.tar.bz2" -C "$prefix" >/dev/null
  $RM "$prefix/dirbuster-0.12.tar.bz2"

  f_print "\n[*] Install web tools - done" "ok"
}

########################################
# NETWORK
########################################
function f_install_tools_network() {
  prefix="$directory/Tools/network"
  f_print "\n[*] Install network tools ($prefix)"

  # testSSL
  f_install_git_clone "TestSSL" "https://github.com/drwetter/testssl.sh.git" "$prefix/testSSL" "--depth 1"
  # Enum4Linux
  f_install_git_clone "Enum4Linux" "https://github.com/portcullislabs/enum4linux.git" "$prefix/enum4linux"
  # Responder
  f_install_git_clone "Responder" "https://github.com/SpiderLabs/Responder.git" "$prefix/responder"
  # impacket
  f_install_git_clone "Impacket" "https://github.com/CoreSecurity/impacket.git" "$prefix/impacket"
  # Sublist3r
  f_install_git_clone "Sublist3r" "https://github.com/aboul3la/Sublist3r.git" "$prefix/sublist3r"

  f_print "\n[*] Install network tools - done" "ok"
}

########################################
# PWCracking
########################################
function f_install_tools_pwcracking() {
  prefix="$directory/Tools/pwcracking"
  f_print "\n[*] Install password cracking tools ($prefix)"

  # JTR
  f_install_git_clone "JohnTheRipper" "https://github.com/magnumripper/JohnTheRipper.git" "$prefix/johnTheRipper-1.8.0-jumbo1"
  #f_execute_as_low_user "$main_user_name" "cd $prefix/johnTheRipper-1.8.0-jumbo1/src/; ./configure && make"

  # Hashcat
  f_install_wget "Hashcat" "https://hashcat.net/files/hashcat-4.2.0.7z" "/tmp/hashcat-4.2.0.7z"
  $7Z x "/tmp/hashcat-4.2.0.7z" -o"$prefix/"
  $RM "/tmp/hashcat-4.2.0.7z"

  f_print "\n[*] Install password cracking tools - done" "ok"
}

########################################
# Wordlist
########################################
function f_install_tools_wordlists() {
  prefix="$directory/Tools/wordlists"
  f_print "\n[*] Install wordlists ($prefix)"

  # FuzzDB
  f_install_git_clone "FuzzDB" "https://github.com/fuzzdb-project/fuzzdb.git" "$prefix/FuzzDB"
  # wfuzz
  $LN -s "$directory/Tools/web/wfuzz/wordlists" "$prefix/wfuzz"
  # SecLists
  f_install_git_clone "SecLists" "https://github.com/danielmiessler/SecLists.git" "$prefix/SecLists"
  # ProbableWordlists
  f_install_git_clone "ProbableWordlists" "https://github.com/berzerk0/Probable-Wordlists.git" "$prefix/ProbableWordlists"
  # NaugthyStrings
  f_install_git_clone "NaugthyStrings" "https://github.com/minimaxir/big-list-of-naughty-strings.git" "$prefix/NaugthyStrings"

  f_print "\n[*] Install wordlists - done" "ok"
}

########################################
# Forensic
########################################
function f_install_tools_forensic() {
  prefix="$directory/Tools/forensic"
  f_print "\n[*] Install forensic tools ($prefix)"

  # Volatility
  f_install_git_clone "Volatility" "https://github.com/volatilityfoundation/volatility.git" "$prefix/Volatility"

  f_print "\n[*] Install forensic tools - done" "ok"
}

########################################
# Windows
########################################
function f_install_tools_windows() {
  prefix="$directory/Tools/windows"
  f_print "\n[*] Install Windows-related tools ($prefix)"

  # Mimikatz
  f_install_wget "Mimikatz" "https://github.com/gentilkiwi/mimikatz/releases/download/2.1.1-20180616/mimikatz_trunk.7z" "/tmp/mimikatz_trunk.7z"
  $7Z x "/tmp/mimikatz_trunk.7z" -o"$prefix/mimikatz"
  $RM "/tmp/mimikatz_trunk.7z"
  # CME
  $PIP install --user pipenv
  f_install_git_clone "CrackMapExec" "https://github.com/byt3bl33d3r/CrackMapExec" "$prefix/CrackMapExec" "--recursive"
  # cd CrackMapExec && pipenv install
  # pipenv shell
  # python setup.py install

  # Nishang
  f_install_git_clone "Nishang" "https://github.com/samratashok/nishang.git" "$prefix/Nishang"
  # PowerSploit
  f_install_git_clone "PowerSploit" "https://github.com/PowerShellMafia/PowerSploit.git" "$prefix/PowerSploit"
  # Empire
  f_install_git_clone "Empire" "https://github.com/EmpireProject/Empire.git" "$prefix/Empire"

  f_print "\n[*] Install Windows-related tools - done" "ok"
}

########################################
# Generic
########################################
function f_install_tools_XXX() {
  prefix="$directory/Tools/XXX"
  f_print "\n[*] Install XXX tools ($prefix)"

  # XXX

  f_print "\n[*] Install XXX tools - done" "ok"
}
